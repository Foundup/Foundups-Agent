# WSP 62: Large File and Refactoring Enforcement Protocol
- **Status:** Active
- **Purpose:** To implement automated file size management and refactoring enforcement across the WRE system, preventing uncontrolled growth of code files while maintaining modular architecture.
- **Trigger:** During FMAS validation, WRE session initialization, pre-commit validation, and automated build processes.
- **Input:** File paths, size thresholds, domain configurations, and exemption rules.
- **Output:** Size compliance reports, refactoring recommendations, and enforcement actions.
- **Responsible Agent(s):** ComplianceAgent, ModularizationAuditAgent, TestingAgent

[SEMANTIC SCORE: 2.2.2]
[ARCHIVE STATUS: ACTIVE_PARTIFACT]
[ORIGIN: WSP_framework/src/WSP_62_Large_File_Refactoring_Enforcement_Protocol.md - Created by 0102]

## 1. Overview

This protocol implements comprehensive file size management and refactoring enforcement to prevent uncontrolled growth of code files and ensure maintainable modular structure. WSP 62 integrates with existing WSP protocols to provide automated detection, warnings, and enforcement of size-based refactoring requirements.

## 2. File Size Thresholds

### 2.1. Default Threshold Definitions

#### 2.1.1. Code Files
- **Python Files (.py)**: 500 lines
- **JavaScript/TypeScript (.js/.ts)**: 400 lines
- **Configuration Files (.json/.yaml/.toml)**: 200 lines
- **Shell Scripts (.sh/.ps1)**: 300 lines
- **Documentation (.md)**: 1,000 lines

#### 2.1.2. Non-Code Files
- **Binary Files**: 1MB
- **Image Files**: 5MB
- **Data Files (.csv/.json data)**: 10MB
- **Archive Files**: 50MB

#### 2.1.3. Secondary Thresholds (Class/Function Level)
- **Python Functions**: 50 lines
- **Python Classes**: 200 lines
- **JavaScript Functions**: 30 lines
- **Complex Logic Blocks**: 100 lines

### 2.2. Domain-Specific Configurations

#### 2.2.1. Enterprise Domain Overrides
```yaml
# modules/[domain]/wsp_62_config.yaml
thresholds:
  ai_intelligence:
    python_files: 600      # AI models may be larger
    class_limit: 300       # Complex neural architectures
  infrastructure:
    python_files: 400      # Infrastructure should be lean
    config_files: 150      # Tight configuration control
  communication:
    python_files: 450      # Protocol handlers
    function_limit: 40     # Message processing functions
```

#### 2.2.2. Module-Specific Overrides
```yaml
# modules/[domain]/[module]/wsp_62_config.yaml
module_overrides:
  exemptions:
    - "src/autogenerated_*.py"
    - "tests/test_data_*.py"
  custom_thresholds:
    "src/core_engine.py": 800  # Core engine exception
```

## 3. Enforcement Rules

### 3.1. Trigger Conditions

#### 3.1.1. Size Threshold Exceeded
When a file exceeds its threshold:
1. **IMMEDIATE**: Log violation in WSP_MODULE_VIOLATIONS.md (WSP 47)
2. **BLOCK**: Prevent pre-commit if no exemption exists
3. **WARN**: Display refactoring requirement in WRE UI
4. **SUGGEST**: Provide automated refactoring recommendations

#### 3.1.2. Growth Rate Monitoring
Monitor files approaching thresholds:
- **80% threshold**: Display warning during development
- **90% threshold**: Require documentation of growth plan
- **95% threshold**: Mandatory refactoring review

### 3.2. Enforcement Actions

#### 3.2.1. Development Phase Enforcement
```python
# Pre-commit hook integration
def enforce_file_sizes():
    violations = []
    for file_path in get_modified_files():
        if exceeds_threshold(file_path):
            if not has_exemption(file_path):
                violations.append(create_violation(file_path))
    
    if violations:
        block_commit(violations)
        display_refactoring_guidance(violations)
```

#### 3.2.2. CI/CD Pipeline Integration
- **Build Blocking**: Fail builds with oversized files
- **Quality Gates**: Require size compliance before deployment
- **Automated Reporting**: Generate size compliance reports

### 3.3. Refactoring Requirements

#### 3.3.1. Mandatory Refactoring Triggers
- **File > 150% threshold**: Immediate refactoring required
- **Class > 300 lines**: Split into multiple classes
- **Function > 75 lines**: Extract sub-functions
- **Config > 250 lines**: Modularize configuration

#### 3.3.2. Refactoring Strategies
1. **Functional Decomposition**: Break large functions into smaller ones
2. **Class Inheritance**: Use inheritance to reduce class size
3. **Module Splitting**: Split large modules into sub-modules
4. **Configuration Externalization**: Move configs to separate files

## 4. WRE Integration

### 4.1. FMAS Enhancement (WSP 4 Integration)

#### 4.1.1. Size Validation Integration
```python
# Enhanced modular_audit.py
class SizeComplianceValidator:
    def validate_file_sizes(self, module_path):
        violations = []
        for file_path in get_all_files(module_path):
            threshold = get_threshold(file_path)
            if get_file_size(file_path) > threshold:
                violations.append(SizeViolation(file_path, threshold))
        return violations
```

#### 4.1.2. FMAS Report Enhancement
```
FMAS VALIDATION REPORT
======================
Structure: PASS
Tests: PASS
Size Compliance: FAIL
  - src/large_module.py (687 lines > 500 threshold)
  - config/complex_config.json (234 lines > 200 threshold)
  
Refactoring Required: 2 files
```

### 4.2. WRE Session Integration

#### 4.2.1. Startup Warnings
```
[U+1F3C4] WRE System Startup
Size Compliance Status: [WARNING][U+FE0F] WARNINGS
- 3 files exceed size thresholds
- 2 files approaching limits (>90%)
- Review required before builds
```

#### 4.2.2. Module Development Integration
Enhance Module Development menu with:
- **Size Status Display**: Show file sizes vs thresholds
- **Refactoring Recommendations**: Suggest splitting strategies
- **Exemption Management**: Handle documented exceptions

### 4.3. Agent Integration (WSP 54 Enhancement)

#### 4.3.1. ModularizationAuditAgent Enhancement
```python
class ModularizationAuditAgent:
    def audit_file_sizes(self):
        """WSP 62 integration for size-based modularity."""
        large_files = self.detect_oversized_files()
        for file_path in large_files:
            refactor_plan = self.generate_refactoring_plan(file_path)
            self.log_violation(file_path, refactor_plan)
            self.surface_to_ui(file_path, refactor_plan)
```

#### 4.3.2. ComplianceAgent Enhancement
```python
class ComplianceAgent:
    def validate_size_compliance(self, module_path):
        """WSP 62 size validation integration."""
        violations = self.size_validator.validate_file_sizes(module_path)
        return self.create_compliance_report(violations)
```

## 5. Exemption Mechanisms

### 5.1. Documented Exemptions

#### 5.1.1. Exemption Declaration
```yaml
# modules/[domain]/[module]/wsp_62_exemptions.yaml
exemptions:
  - file: "src/legacy_integration.py"
    reason: "Legacy system integration - gradual refactoring planned"
    threshold_override: 800
    review_date: "2024-Q2"
    reviewer: "TechnicalArchitect"
  
  - file: "src/autogenerated_api.py"
    reason: "Auto-generated code from external API"
    permanent: true
    generation_tool: "OpenAPI Generator v6.2.1"
```

#### 5.1.2. Exemption Validation
- **Documented Justification**: All exemptions must have clear reasons
- **Review Requirements**: Periodic review of temporary exemptions
- **Approval Process**: Technical architect approval for large exemptions

### 5.2. Automatic Exemptions

#### 5.2.1. File Pattern Exemptions
```python
AUTO_EXEMPT_PATTERNS = [
    "*/tests/test_data_*.py",      # Test data files
    "*/src/autogenerated_*.py",    # Auto-generated code
    "*/migrations/*.py",           # Database migrations
    "*/protobuf/*_pb2.py",        # Protocol buffer files
    "*/vendor/*.py"                # Third-party code
]
```

#### 5.2.2. Content-Based Exemptions
- **Data Structures**: Large data constant definitions
- **Configuration Templates**: Comprehensive config examples
- **API Schemas**: Complete API specification files

## 6. Integration with Existing WSPs

### 6.1. WSP 4 (FMAS Validation Protocol)
- **Enhanced Validation**: Add size checks to structural validation
- **Report Integration**: Include size compliance in FMAS reports
- **Blocking Integration**: Prevent integration of oversized files

### 6.2. WSP 47 (Module Violation Tracking)
- **Violation Logging**: Log all size violations systematically
- **Tracking Categories**: Add "SIZE_VIOLATION" category
- **Resolution Tracking**: Monitor refactoring progress

### 6.3. WSP 54 (WRE Agent Duties)
- **ModularizationAuditAgent**: Enhance with size-based auditing
- **ComplianceAgent**: Add size validation to compliance checks
- **TestingAgent**: Verify refactored code maintains test coverage

### 6.4. WSP 49 (Module Directory Structure)
- **Structural Refactoring**: Ensure refactoring maintains structure
- **Sub-module Creation**: Guide creation of sub-modules for large files
- **Namespace Management**: Maintain clean import paths

## 7. Implementation Phases

### 7.1. Phase 1: Detection and Reporting
- **FMAS Integration**: Add size detection to modular_audit.py
- **Reporting System**: Create size compliance reports
- **UI Integration**: Display warnings in WRE system

### 7.2. Phase 2: Enforcement
- **Pre-commit Hooks**: Block oversized files
- **CI/CD Integration**: Fail builds with size violations
- **Exemption System**: Implement documented exemptions

### 7.3. Phase 3: Automation
- **Refactoring Suggestions**: Automated refactoring recommendations
- **Progressive Enforcement**: Gradual threshold tightening
- **Learning System**: Improve recommendations based on patterns

## 8. Testing and Validation

### 8.1. Size Detection Testing
```python
def test_size_detection():
    """Test WSP 62 size detection accuracy."""
    large_file = create_test_file(600)  # Exceeds 500 line threshold
    violations = size_validator.validate_file_sizes([large_file])
    assert len(violations) == 1
    assert violations[0].file_path == large_file
```

### 8.2. Exemption Testing
```python
def test_exemption_handling():
    """Test WSP 62 exemption mechanism."""
    exempt_file = "src/autogenerated_api.py"
    add_exemption(exempt_file, "Auto-generated code")
    violations = size_validator.validate_file_sizes([exempt_file])
    assert len(violations) == 0
```

### 8.3. Integration Testing
- **FMAS Integration**: Verify size checks work with existing validation
- **WRE Integration**: Test startup warnings and UI integration
- **Agent Integration**: Validate enhanced agent functionality

## 9. Performance Considerations

### 9.1. Optimization Strategies
- **Caching**: Cache file size calculations
- **Incremental**: Only check modified files
- **Parallel Processing**: Concurrent size validation
- **Smart Thresholds**: Dynamic thresholds based on file type

### 9.2. Resource Management
- **Memory Efficiency**: Stream large files for size checking
- **CPU Usage**: Optimize size calculation algorithms
- **Storage**: Efficient violation logging and reporting

## 10. Success Metrics

### 10.1. Code Quality Metrics
- **Average File Size**: Maintain below threshold averages
- **Refactoring Frequency**: Track successful refactoring operations
- **Violation Reduction**: Measure decrease in size violations over time

### 10.2. Development Productivity
- **Build Success Rate**: Maintain high build success with size enforcement
- **Developer Satisfaction**: Measure impact on development workflow
- **Maintenance Efficiency**: Track reduced maintenance due to modular code

## 11. Future Enhancements

### 11.1. Advanced Features
- **ML-Based Predictions**: Predict files likely to exceed thresholds
- **Automated Refactoring**: AI-assisted code splitting
- **Dynamic Thresholds**: Adjust thresholds based on project patterns

### 11.2. Integration Opportunities
- **IDE Integration**: Real-time size warnings in development
- **Code Review**: Automatic size review in pull requests
- **Metrics Dashboard**: Visual size compliance tracking

---

**WSP 62 Status**: Active and ready for implementation across all WRE systems.
**Next Steps**: Integrate with WSP 4, WSP 47, WSP 54, and enhance modular_audit.py with size validation capabilities. 