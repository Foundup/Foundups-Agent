rules_version = '2';

/**
 * Firestore Security Rules - GotJunk FoundUp
 * WSP 98: FoundUps Mesh-Native Architecture Protocol - Layer 2 (Global Index)
 *
 * Authentication Strategy:
 * - Anonymous Auth: Auto sign-in (zero friction)
 * - Google Sign-In: Cross-device sync (same Google account = same UID)
 *
 * Security Model:
 * - Reads: Public (anyone can browse items)
 * - Writes: Authenticated users only
 * - Ownership: Users can only modify their own items (ownerUid == auth.uid)
 * - Moderation: Community voting allowed (see community moderation rules)
 *
 * Collections:
 * - gotjunk_items: Item metadata (classification, price, location, etc.)
 * - gotjunk_blobs: Base64 encoded blobs (for small images <500KB)
 *
 * Future:
 * - Add role-based access for trusted moderators
 * - Add rate limiting to prevent spam
 * - Add geofencing rules (restrict writes to nearby locations)
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    /**
     * Check if user is authenticated (anonymous or Google sign-in)
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Check if user owns the document
     */
    function isOwner(ownerUid) {
      return isAuthenticated() && request.auth.uid == ownerUid;
    }

    /**
     * Validate item data structure
     */
    function isValidItem() {
      let data = request.resource.data;
      return data.keys().hasAll(['id', 'ownerUid', 'status', 'createdAt', 'updatedAt'])
        && data.ownerUid is string
        && data.status in ['draft', 'listed', 'browsing', 'in_cart', 'skipped', 'purchased']
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }

    /**
     * Validate moderation update
     */
    function isValidModerationUpdate() {
      let data = request.resource.data;
      // Only allow updating moderation fields, not ownership or core data
      return data.diff(resource.data).affectedKeys().hasOnly([
        'reportCount',
        'moderationVotes',
        'moderationStatus',
        'reportedBy',
        'updatedAt'
      ]);
    }

    // ============================================================================
    // ITEMS COLLECTION: gotjunk_items
    // ============================================================================

    match /gotjunk_items/{itemId} {

      // READ: Public (anyone can browse items)
      // Future: Add geofencing (only show items within 50km of user)
      allow read: if true;

      // CREATE: Authenticated users only
      // Must set ownerUid to their own UID
      allow create: if isAuthenticated()
        && isValidItem()
        && request.resource.data.ownerUid == request.auth.uid;

      // UPDATE: Owner only OR community moderation
      allow update: if isOwner(resource.data.ownerUid)
        || (isAuthenticated() && isValidModerationUpdate());

      // DELETE: Owner only
      allow delete: if isOwner(resource.data.ownerUid);
    }

    // ============================================================================
    // BLOBS COLLECTION: gotjunk_blobs (for small images <500KB)
    // ============================================================================

    match /gotjunk_blobs/{blobId} {

      // READ: Public
      allow read: if true;

      // WRITE: Authenticated users only
      // Match blob ID to item ID for ownership verification
      allow write: if isAuthenticated()
        && exists(/databases/$(database)/documents/gotjunk_items/$(blobId))
        && get(/databases/$(database)/documents/gotjunk_items/$(blobId)).data.ownerUid == request.auth.uid;
    }

    // ============================================================================
    // FUTURE COLLECTIONS
    // ============================================================================

    // Users collection (for profiles, reputation, etc.)
    // match /gotjunk_users/{userId} {
    //   allow read: if true;
    //   allow write: if isAuthenticated() && request.auth.uid == userId;
    // }

    // Transactions collection (for purchase history)
    // match /gotjunk_transactions/{transactionId} {
    //   allow read: if isAuthenticated()
    //     && (request.auth.uid == resource.data.buyerUid
    //         || request.auth.uid == resource.data.sellerUid);
    //   allow create: if isAuthenticated()
    //     && request.resource.data.buyerUid == request.auth.uid;
    // }

    // Block all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
